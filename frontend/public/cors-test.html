<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend Connectivity Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }

        .success {
            background-color: #dff0d8;
            color: #3c763d;
        }

        .error {
            background-color: #f2dede;
            color: #a94442;
        }

        .loading {
            background-color: #d9edf7;
            color: #31708f;
        }

        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>Backend Connectivity Test</h1>
    <p>This page tests connectivity to your backend server and CORS configuration.</p>

    <div>
        <label for="backendUrl">Backend URL:</label>
        <input type="text" id="backendUrl" style="width: 400px;"
            value="https://lmcvf9h0-5000.inc1.devtunnels.ms/api/v1" />
    </div>

    <div style="margin-top: 20px;">
        <button onclick="testOptions()">Test OPTIONS (CORS Preflight)</button>
        <button onclick="testGet()">Test GET Request</button>
        <button onclick="testAuth()">Test Auth Endpoint</button>
    </div>

    <div id="result" class="result loading" style="display: none;">
        Running test...
    </div>

    <div id="details" style="display: none;">
        <h3>Response Details:</h3>
        <pre id="responseDetails"></pre>
    </div>

    <script>
        async function testOptions() {
            const resultDiv = document.getElementById('result');
            const detailsDiv = document.getElementById('details');
            const responseDetails = document.getElementById('responseDetails');
            const backendUrl = document.getElementById('backendUrl').value;

            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'Testing OPTIONS request (CORS preflight)...';

            try {
                const response = await fetch(backendUrl + '/auth/login', {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type, Authorization'
                    }
                });

                const headers = {};
                response.headers.forEach((value, key) => {
                    headers[key] = value;
                });

                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers'),
                    'Access-Control-Allow-Credentials': response.headers.get('Access-Control-Allow-Credentials')
                };

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 'OPTIONS request successful! Status: ' + response.status;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'OPTIONS request failed! Status: ' + response.status;
                }

                detailsDiv.style.display = 'block';
                responseDetails.textContent = JSON.stringify({
                    status: response.status,
                    statusText: response.statusText,
                    corsHeaders: corsHeaders,
                    allHeaders: headers
                }, null, 2);

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Error: ' + error.message;

                detailsDiv.style.display = 'block';
                responseDetails.textContent = JSON.stringify({
                    error: error.message,
                    stack: error.stack
                }, null, 2);
            }
        }

        async function testGet() {
            const resultDiv = document.getElementById('result');
            const detailsDiv = document.getElementById('details');
            const responseDetails = document.getElementById('responseDetails');
            const backendUrl = document.getElementById('backendUrl').value;

            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'Testing GET request...';

            try {
                const response = await fetch(backendUrl + '/status', {
                    method: 'GET',
                    headers: {
                        'Origin': window.location.origin
                    }
                });

                const headers = {};
                response.headers.forEach((value, key) => {
                    headers[key] = value;
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 'GET request successful! Status: ' + response.status;

                    detailsDiv.style.display = 'block';
                    responseDetails.textContent = JSON.stringify({
                        status: response.status,
                        headers: headers,
                        data: data
                    }, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'GET request failed! Status: ' + response.status;

                    detailsDiv.style.display = 'block';
                    responseDetails.textContent = JSON.stringify({
                        status: response.status,
                        statusText: response.statusText,
                        headers: headers
                    }, null, 2);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Error: ' + error.message;

                detailsDiv.style.display = 'block';
                responseDetails.textContent = JSON.stringify({
                    error: error.message,
                    stack: error.stack
                }, null, 2);
            }
        }

        async function testAuth() {
            const resultDiv = document.getElementById('result');
            const detailsDiv = document.getElementById('details');
            const responseDetails = document.getElementById('responseDetails');
            const backendUrl = document.getElementById('backendUrl').value;

            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'Testing Auth endpoint...';

            try {
                // First do an OPTIONS request to simulate the preflight
                await fetch(backendUrl + '/auth/login', {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type, Authorization'
                    }
                });

                // Now do the actual POST request
                const response = await fetch(backendUrl + '/auth/login', {
                    method: 'POST',
                    headers: {
                        'Origin': window.location.origin,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'test',
                        password: 'test'
                    }),
                    credentials: 'include'
                });

                const headers = {};
                response.headers.forEach((value, key) => {
                    headers[key] = value;
                });

                const responseText = await response.text();
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = responseText;
                }

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 'Auth test successful! Status: ' + response.status;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'Auth test failed! Status: ' + response.status;
                }

                detailsDiv.style.display = 'block';
                responseDetails.textContent = JSON.stringify({
                    status: response.status,
                    statusText: response.statusText,
                    headers: headers,
                    data: responseData
                }, null, 2);

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Error: ' + error.message;

                detailsDiv.style.display = 'block';
                responseDetails.textContent = JSON.stringify({
                    error: error.message,
                    stack: error.stack
                }, null, 2);
            }
        }
    </script>
</body>

</html>